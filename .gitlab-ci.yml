stages:
  - lint
  - test
  - build

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  DOCKER_TAG: $CI_COMMIT_SHORT_SHA

# Go代码lint检查
lint-backend:
  stage: lint
  image: golang:1.21
  before_script:
    - curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.61.0
  script:
    - golangci-lint run ./backend/...
  only:
    changes:
      - backend/**/*
      - go.mod
      - go.sum
      - .golangci.yml
    refs:
      - main
      - merge_requests
  allow_failure: false

# 前端ESLint检查
lint-frontend:
  stage: lint
  image: node:18-alpine
  script:
    - cd frontend
    - npm ci
    - npm run lint
  cache:
    key: npm-modules
    paths:
      - frontend/node_modules/
  only:
    changes:
      - frontend/**/*
    refs:
      - main
      - merge_requests
  allow_failure: false

# 后端Go编译测试
test-backend:
  stage: test
  image: golang:1.21
  script:
    - go mod download
    - CGO_ENABLED=0 go build -o main ./backend
    - go test ./backend/... -v
  cache:
    key: go-modules
    paths:
      - /go/pkg/mod/
  only:
    changes:
      - backend/**/*
      - go.mod
      - go.sum
    refs:
      - main
      - merge_requests

# 前端构建测试
test-frontend:
  stage: test
  image: node:18-alpine
  script:
    - cd frontend
    - npm ci
    - npm run build
  cache:
    key: npm-modules
    paths:
      - frontend/node_modules/
  only:
    changes:
      - frontend/**/*
    refs:
      - main
      - merge_requests

# 构建并推送Docker镜像
build-docker:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $DOCKER_IMAGE:$DOCKER_TAG -t $DOCKER_IMAGE:latest .
    - docker push $DOCKER_IMAGE:$DOCKER_TAG
    - docker push $DOCKER_IMAGE:latest
  only:
    - main
  when: on_success
  needs:
    - job: test-backend
      optional: true
    - job: test-frontend
      optional: true

# 带版本标签的发布构建
build-release:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $DOCKER_IMAGE:$CI_COMMIT_TAG .
    - docker push $DOCKER_IMAGE:$CI_COMMIT_TAG
  only:
    - tags

# 构建FreeBSD可执行文件
build-freebsd:
  stage: build
  image: golang:1.21
  script:
    - go mod download
    - GOOS=freebsd GOARCH=amd64 CGO_ENABLED=0 go build -o singbox-proxy-manager-freebsd-amd64 ./backend
  artifacts:
    name: "singbox-proxy-manager-freebsd-$CI_COMMIT_SHORT_SHA"
    paths:
      - singbox-proxy-manager-freebsd-amd64
    expire_in: 30 days
  only:
    - main
    - tags

# 构建Linux可执行文件（不依赖Docker）
build-linux:
  stage: build
  image: golang:1.21
  script:
    - go mod download
    - GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o singbox-proxy-manager-linux-amd64 ./backend
  artifacts:
    name: "singbox-proxy-manager-linux-$CI_COMMIT_SHORT_SHA"
    paths:
      - singbox-proxy-manager-linux-amd64
    expire_in: 30 days
  only:
    - main
    - tags
