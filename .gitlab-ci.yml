stages:
  - lint
  - test
  - build
  - release

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  DOCKER_TAG: $CI_COMMIT_SHORT_SHA

# Go代码lint检查
lint-backend:
  stage: lint
  image: golang:1.23
  before_script:
    - curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.61.0
  script:
    - golangci-lint run ./backend/...
  only:
    changes:
      - backend/**/*
      - go.mod
      - go.sum
      - .golangci.yml
    refs:
      - main
      - merge_requests
  allow_failure: false

# 前端ESLint检查
lint-frontend:
  stage: lint
  image: node:18-alpine
  script:
    - cd frontend
    - npm ci
    - npm run lint
  cache:
    key: npm-modules
    paths:
      - frontend/node_modules/
  only:
    changes:
      - frontend/**/*
    refs:
      - main
      - merge_requests
  allow_failure: false

# 后端Go编译测试
test-backend:
  stage: test
  image: golang:1.23
  script:
    - go mod download
    - CGO_ENABLED=0 go build -o main ./backend
    - go test ./backend/... -v
  cache:
    key: go-modules
    paths:
      - /go/pkg/mod/
  only:
    changes:
      - backend/**/*
      - go.mod
      - go.sum
    refs:
      - main
      - merge_requests

# 前端构建测试
test-frontend:
  stage: test
  image: node:18-alpine
  script:
    - cd frontend
    - npm ci
    - npm run build
  cache:
    key: npm-modules
    paths:
      - frontend/node_modules/
  only:
    changes:
      - frontend/**/*
    refs:
      - main
      - merge_requests

# 构建并推送Docker镜像
build-docker:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $DOCKER_IMAGE:$DOCKER_TAG -t $DOCKER_IMAGE:latest .
    - docker push $DOCKER_IMAGE:$DOCKER_TAG
    - docker push $DOCKER_IMAGE:latest
  only:
    - main
  when: on_success
  needs:
    - job: test-backend
      optional: true
    - job: test-frontend
      optional: true

# 带版本标签的发布构建
build-release:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $DOCKER_IMAGE:$CI_COMMIT_TAG .
    - docker push $DOCKER_IMAGE:$CI_COMMIT_TAG
  only:
    - tags

# 构建前端（供其他job使用）
build-frontend-dist:
  stage: build
  image: node:18-alpine
  script:
    - cd frontend
    - npm ci
    - npm run build
  artifacts:
    paths:
      - frontend/dist/
    expire_in: 1 day
  only:
    - main
    - tags

# 构建FreeBSD完整发布包
build-freebsd:
  stage: build
  image: golang:1.23
  needs:
    - job: build-frontend-dist
      artifacts: true
  variables:
    SINGBOX_VERSION: "1.12.12"
  script:
    - go mod download
    - GOOS=freebsd GOARCH=amd64 CGO_ENABLED=0 go build -o main ./backend
    # 从源码编译FreeBSD版sing-box（官方无预编译版）
    - git clone --depth 1 --branch v${SINGBOX_VERSION} https://github.com/SagerNet/sing-box.git
    - cd sing-box && GOOS=freebsd GOARCH=amd64 CGO_ENABLED=0 go build -o ../sing-box ./cmd/sing-box && cd ..
    # 创建发布包
    - mkdir -p singbox-proxy-manager-freebsd-amd64/frontend
    - mv main singbox-proxy-manager-freebsd-amd64/
    - mv sing-box singbox-proxy-manager-freebsd-amd64/
    - cp -r frontend/dist singbox-proxy-manager-freebsd-amd64/frontend/
    - mkdir -p singbox-proxy-manager-freebsd-amd64/config
    # 创建启动脚本
    - |
      cat > singbox-proxy-manager-freebsd-amd64/start.sh << 'EOF'
      #!/bin/sh
      cd "$(dirname "$0")"
      export PATH="$PWD:$PATH"
      export CONFIG_DIR="$PWD/config"
      export PORT="${PORT:-30000}"
      export ADMIN_PASSWORD="${ADMIN_PASSWORD:-admin123}"
      ./main
      EOF
    - chmod +x singbox-proxy-manager-freebsd-amd64/start.sh
    - tar czf singbox-proxy-manager-freebsd-amd64.tar.gz singbox-proxy-manager-freebsd-amd64/
  artifacts:
    name: "singbox-proxy-manager-freebsd-$CI_COMMIT_SHORT_SHA"
    paths:
      - singbox-proxy-manager-freebsd-amd64.tar.gz
    expire_in: 30 days
  only:
    - main
    - tags

# 构建Linux完整发布包
build-linux:
  stage: build
  image: golang:1.23
  needs:
    - job: build-frontend-dist
      artifacts: true
  variables:
    SINGBOX_VERSION: "1.12.12"
  script:
    - go mod download
    - GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o main ./backend
    # 下载Linux版sing-box
    - apt-get update && apt-get install -y curl
    - curl -fLo sing-box.tar.gz "https://github.com/SagerNet/sing-box/releases/download/v${SINGBOX_VERSION}/sing-box-${SINGBOX_VERSION}-linux-amd64.tar.gz"
    - tar xzf sing-box.tar.gz
    - mv sing-box-*/sing-box .
    # 创建发布包
    - mkdir -p singbox-proxy-manager-linux-amd64/frontend
    - mv main singbox-proxy-manager-linux-amd64/
    - mv sing-box singbox-proxy-manager-linux-amd64/
    - cp -r frontend/dist singbox-proxy-manager-linux-amd64/frontend/
    - mkdir -p singbox-proxy-manager-linux-amd64/config
    # 创建启动脚本
    - |
      cat > singbox-proxy-manager-linux-amd64/start.sh << 'EOF'
      #!/bin/sh
      cd "$(dirname "$0")"
      export PATH="$PWD:$PATH"
      export CONFIG_DIR="$PWD/config"
      export PORT="${PORT:-30000}"
      export ADMIN_PASSWORD="${ADMIN_PASSWORD:-admin123}"
      ./main
      EOF
    - chmod +x singbox-proxy-manager-linux-amd64/start.sh
    - tar czf singbox-proxy-manager-linux-amd64.tar.gz singbox-proxy-manager-linux-amd64/
  artifacts:
    name: "singbox-proxy-manager-linux-$CI_COMMIT_SHORT_SHA"
    paths:
      - singbox-proxy-manager-linux-amd64.tar.gz
    expire_in: 30 days
  only:
    - main
    - tags

# 自动发布到Releases（main分支push时自动创建tag并发布）
auto-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build-freebsd
      artifacts: false
    - job: build-linux
      artifacts: false
  variables:
    AUTO_TAG: "v0.0.${CI_PIPELINE_IID}"
  script:
    - echo "Auto-creating release ${AUTO_TAG} for commit ${CI_COMMIT_SHORT_SHA}"
  release:
    tag_name: $AUTO_TAG
    name: "Auto Release ${AUTO_TAG}"
    description: |
      ## 自动构建版本 ${AUTO_TAG}
      
      Commit: ${CI_COMMIT_SHORT_SHA}
      
      ### 完整发布包（开箱即用）
      
      包含：后端程序 + 前端文件 + sing-box + 启动脚本
      
      | 平台 | 下载 |
      |------|------|
      | Linux (amd64) | singbox-proxy-manager-linux-amd64.tar.gz |
      | FreeBSD (amd64) | singbox-proxy-manager-freebsd-amd64.tar.gz |
      | Docker | `docker pull ${CI_REGISTRY_IMAGE}:latest` |
      
      ### 使用方法
      ```bash
      tar xzf singbox-proxy-manager-linux-amd64.tar.gz
      cd singbox-proxy-manager-linux-amd64
      ADMIN_PASSWORD=your_password ./start.sh
      # 访问 http://localhost:30000
      ```
    assets:
      links:
        - name: "singbox-proxy-manager-linux-amd64.tar.gz"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_SHA}/raw/singbox-proxy-manager-linux-amd64.tar.gz?job=build-linux"
          link_type: package
        - name: "singbox-proxy-manager-freebsd-amd64.tar.gz"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_SHA}/raw/singbox-proxy-manager-freebsd-amd64.tar.gz?job=build-freebsd"
          link_type: package
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'

# 手动tag发布到Releases（手动创建tag时触发）
release-binaries:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build-freebsd
      artifacts: false
    - job: build-linux
      artifacts: false
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: |
      ## 正式发布版本 ${CI_COMMIT_TAG}
      
      ### 完整发布包（开箱即用）
      
      包含：后端程序 + 前端文件 + sing-box + 启动脚本
      
      | 平台 | 下载 |
      |------|------|
      | Linux (amd64) | singbox-proxy-manager-linux-amd64.tar.gz |
      | FreeBSD (amd64) | singbox-proxy-manager-freebsd-amd64.tar.gz |
      | Docker | `docker pull ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}` |
      
      ### 使用方法
      ```bash
      tar xzf singbox-proxy-manager-linux-amd64.tar.gz
      cd singbox-proxy-manager-linux-amd64
      ADMIN_PASSWORD=your_password ./start.sh
      # 访问 http://localhost:30000
      ```
    assets:
      links:
        - name: "singbox-proxy-manager-linux-amd64.tar.gz"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/singbox-proxy-manager-linux-amd64.tar.gz?job=build-linux"
          link_type: package
        - name: "singbox-proxy-manager-freebsd-amd64.tar.gz"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/singbox-proxy-manager-freebsd-amd64.tar.gz?job=build-freebsd"
          link_type: package
  only:
    - tags
