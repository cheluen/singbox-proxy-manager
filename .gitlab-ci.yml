stages:
  - lint
  - test
  - build
  - release

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  DOCKER_TAG: $CI_COMMIT_SHORT_SHA

# Go代码lint检查
lint-backend:
  stage: lint
  image: golang:1.21
  before_script:
    - curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.61.0
  script:
    - golangci-lint run ./backend/...
  only:
    changes:
      - backend/**/*
      - go.mod
      - go.sum
      - .golangci.yml
    refs:
      - main
      - merge_requests
  allow_failure: false

# 前端ESLint检查
lint-frontend:
  stage: lint
  image: node:18-alpine
  script:
    - cd frontend
    - npm ci
    - npm run lint
  cache:
    key: npm-modules
    paths:
      - frontend/node_modules/
  only:
    changes:
      - frontend/**/*
    refs:
      - main
      - merge_requests
  allow_failure: false

# 后端Go编译测试
test-backend:
  stage: test
  image: golang:1.21
  script:
    - go mod download
    - CGO_ENABLED=0 go build -o main ./backend
    - go test ./backend/... -v
  cache:
    key: go-modules
    paths:
      - /go/pkg/mod/
  only:
    changes:
      - backend/**/*
      - go.mod
      - go.sum
    refs:
      - main
      - merge_requests

# 前端构建测试
test-frontend:
  stage: test
  image: node:18-alpine
  script:
    - cd frontend
    - npm ci
    - npm run build
  cache:
    key: npm-modules
    paths:
      - frontend/node_modules/
  only:
    changes:
      - frontend/**/*
    refs:
      - main
      - merge_requests

# 构建并推送Docker镜像
build-docker:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $DOCKER_IMAGE:$DOCKER_TAG -t $DOCKER_IMAGE:latest .
    - docker push $DOCKER_IMAGE:$DOCKER_TAG
    - docker push $DOCKER_IMAGE:latest
  only:
    - main
  when: on_success
  needs:
    - job: test-backend
      optional: true
    - job: test-frontend
      optional: true

# 带版本标签的发布构建
build-release:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $DOCKER_IMAGE:$CI_COMMIT_TAG .
    - docker push $DOCKER_IMAGE:$CI_COMMIT_TAG
  only:
    - tags

# 构建FreeBSD可执行文件
build-freebsd:
  stage: build
  image: golang:1.21
  script:
    - go mod download
    - GOOS=freebsd GOARCH=amd64 CGO_ENABLED=0 go build -o singbox-proxy-manager-freebsd-amd64 ./backend
  artifacts:
    name: "singbox-proxy-manager-freebsd-$CI_COMMIT_SHORT_SHA"
    paths:
      - singbox-proxy-manager-freebsd-amd64
    expire_in: 30 days
  only:
    - main
    - tags

# 构建Linux可执行文件（不依赖Docker）
build-linux:
  stage: build
  image: golang:1.21
  script:
    - go mod download
    - GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o singbox-proxy-manager-linux-amd64 ./backend
  artifacts:
    name: "singbox-proxy-manager-linux-$CI_COMMIT_SHORT_SHA"
    paths:
      - singbox-proxy-manager-linux-amd64
    expire_in: 30 days
  only:
    - main
    - tags

# 自动发布到Releases（仅tag触发）
release-binaries:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build-freebsd
      artifacts: true
    - job: build-linux
      artifacts: true
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: |
      ## 下载
      - **Linux (amd64)**: singbox-proxy-manager-linux-amd64
      - **FreeBSD (amd64)**: singbox-proxy-manager-freebsd-amd64
      - **Docker**: `docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG`
      
      ## 使用说明
      1. 下载对应平台的可执行文件
      2. 下载前端dist目录（从源码构建或Docker镜像中提取）
      3. 下载sing-box对应平台版本
      4. 运行: `./singbox-proxy-manager-linux-amd64`
    assets:
      links:
        - name: "singbox-proxy-manager-linux-amd64"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/singbox-proxy-manager-linux-amd64"
          filepath: "/binaries/singbox-proxy-manager-linux-amd64"
          link_type: package
        - name: "singbox-proxy-manager-freebsd-amd64"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/singbox-proxy-manager-freebsd-amd64"
          filepath: "/binaries/singbox-proxy-manager-freebsd-amd64"
          link_type: package
  only:
    - tags
